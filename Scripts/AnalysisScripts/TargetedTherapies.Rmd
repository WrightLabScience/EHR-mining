---
title: "TargetedTherapies"
output: html_document
date: "`r Sys.Date()`"
---

```{r echo=FALSE, message=FALSE, fig.height=6}
library(dplyr)
load(file = '~/Desktop/EHR/EHR-mining/UsefulDataForCleaning/data_path_name.Rdata')
load(file = paste0(data_path_name, 'ASTs_AbxAdmin_blood_2017_2023_imputed_flagged.Rdata'))
load(file = paste0(data_path_name, 'ASTs_AbxAdmin_blood_2017_2023_flagged.Rdata'))
load(file = '~/Desktop/EHR/EHR-mining/UsefulDataForCleaning/antibiotic_names/abbr_named.Rdata')
abbr <- c(abbr, setNames('No abx', 'No abx'))



makeBarplot <- function(bug, drug, status, whole, xmax) {
   if (length(drug) == 2L) {
      x <- empDF$TARG_ABBR[intersect(which(empDF$BUG==bug), intersect(which(empDF[[drug[1]]]==status[2]), which(empDF[[drug[2]]]==status[2])))]
      resistance_phenotype <- paste(paste(abbr[drug], '-', ifelse(status==1L, 'R', 'S'), sep=''), collapse=' / ')
   } else if (length(drug) == 1L) {
      x <- empDF$TARG_ABBR[intersect(which(empDF$BUG==bug), which(empDF[[drug]]==status))]
      resistance_phenotype <- paste0(abbr[drug], '-', ifelse(status==1L, 'R', 'S'))
   }
   total <- length(x)
   
   if (whole) {
      x[x == ''] <- 'No abx'
      t <- table(x)
      t <- sort(t, decreasing=TRUE)
      t <- head(t, n=8)
      abx_nums <- unname(t)
      abx_names <- names(t)
      t <- t / total * 100
      abx_pos <- unname(t)
   } else {
      t <- strsplit(x, '+', fixed=TRUE)
      t[lengths(t) == 0L] <- 'No abx'
      t <- sort(table(unlist(t)), decreasing = TRUE)
      t <- head(t, 8)
      abx_names <- names(t)
      abx_nums <- unname(t)
      t <- sapply(seq_along(t), function(i) {
         if (names(t)[i] == 'No abx') return(c('FALSE'=unname(t[i]), 'TRUE'=0L))
         tab <- table(grepl('+', x[grep(names(t)[i], x)], fixed=TRUE))
         if (length(tab) == 2L) return(tab)
         if (length(tab) == 1L & names(tab) == 'TRUE') return(c('FALSE'=0L, tab))
         if (length(tab) == 1L & names(tab) == 'FALSE') return(c(tab, 'TRUE'=0L))
      })
      t <- t[2:1,]
      colnames(t) <- abx_names
      rownames(t)[rownames(t) == 'FALSE'] <- 'Mono'
      rownames(t)[rownames(t) == 'TRUE'] <- 'Combin.'
      t <- t / total * 100
      abx_pos <- colSums(t)
   }
   
   main <- paste0(gsub('^([A-Z])[a-z]+ ([a-z]+)', '\\1\\. \\2', bug), ' ', resistance_phenotype, '\n', ifelse(whole, 'whole', 'single'), ', n=', total)
   b <- barplot(t, horiz=TRUE, plot=FALSE)
   barplot(t, horiz=TRUE, xlim=c(0, xmax), xlab='% of infections', yaxt='n', leg=!whole)
   title(main=main, cex.main=0.9, line=0, font.main=4)
   axis(side=1, las=1)
   text(x=abx_pos+1, y=b, adj=0, labels=round(abx_nums, 1))
   text(x=-1, y=b, adj=1, labels=abx_names, xpd=NA)
}

makeBugPlot <- function(bug, drug, status=list(0,1), xmax=50) {
   par(oma=c(1,0,1,0), mfrow=c(2,2), mgp=c(1.5, 0.4, 0), tck=-0.015, mar=c(2.5, 8, 3, 0))
   makeBarplot(bug, drug, status[[1]], TRUE, xmax)
   par(mar=c(2.5, 4, 3, 4))
   makeBarplot(bug, drug, status[[1]], FALSE, xmax)
   par(mar=c(2.5, 8, 3, 0))
   makeBarplot(bug, drug, status[[2]], TRUE, xmax)
   par(mar=c(2.5, 4, 3, 4))
   makeBarplot(bug, drug, status[[2]], FALSE, xmax)
}


makeBugPlot('Enterococcus faecium', c('VANCOMYCIN', 'AMPICILLIN'), list(c(0,0), c(1,1)))
makeBugPlot('Staphylococcus aureus', 'OXACILLIN', xmax=75)
makeBugPlot('Klebsiella pneumoniae', drug='PIPERACILLIN/TAZOBACTAM')
makeBugPlot('Klebsiella pneumoniae', drug='TRIMETHOPRIM/SULFAMETHOXAZOLE')
makeBugPlot('Escherichia coli', drug='CIPROFLOXACIN')
makeBugPlot('Escherichia coli', drug='TRIMETHOPRIM/SULFAMETHOXAZOLE')
makeBugPlot('Enterococcus faecalis', drug='RIFAMPIN')
makeBugPlot('Streptococcus pneumoniae', drug='ERYTHROMYCIN')
makeBugPlot('Pseudomonas aeruginosa', drug='CIPROFLOXACIN')
makeBugPlot('Serratia marcescens', drug='CEFTRIAXONE')
makeBugPlot('Serratia marcescens', drug='PIPERACILLIN/TAZOBACTAM')
makeBugPlot('Enterobacter cloacae', drug='PIPERACILLIN/TAZOBACTAM')


e <- empDF$TARG_ABBR[grep('Klebsiella|Escherichia|Acinetobacter|Citrobacter|Enterobacter|Morganella|Serratia|Proteus|Pseudomonas', empDF$BUG)]


```






















