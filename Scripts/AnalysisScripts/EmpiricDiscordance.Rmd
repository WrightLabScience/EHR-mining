---
title: "Empiric Discordance"
output: html_document
date: "`r Sys.Date()`"
---

```{r, echo=FALSE, message=FALSE, fig.height=4}
library(dplyr, quietly = TRUE)
load(file = '~/Desktop/EHR/EHR-mining/UsefulDataForCleaning/data_path_name.Rdata')
load(file = '~/Desktop/EHR/EHR-mining/UsefulDataForCleaning/antibiotic_names/abbr_named.Rdata')

load(file = '~/Desktop/EHR/EHR work/RdataFiles/ASTs_AbxAdmin_blood_2017_2023_flagged.Rdata')
load(file = '~/Desktop/EHR/EHR work/RdataFiles/ASTs_AbxAdmin_blood_2017_2023_imputed_flagged.Rdata')

df <- empDF %>% 
   select(PERSON_ID, ORDER_DAY, BUG, EMPIRIC0, FLAG0) %>% 
   distinct() %>% 
   summarise(EMPIRIC0 = list(unique(unlist(EMPIRIC0))),
             BUG = paste0(sort(unique(BUG)), collapse=' + '),
             FLAG0 = paste(sort(unique(FLAG0)), collapse=' + '),
             .by=c(PERSON_ID, ORDER_DAY)) %>%
   mutate(FLAG0 = case_when(
      grepl('+', FLAG0, fixed=TRUE) & grepl('DISCORDANT', FLAG0) ~ 'DISCORDANT',
      grepl('+', FLAG0, fixed=TRUE) & !grepl('DISCORDANT', FLAG0) & grepl('CONCORDANT', FLAG0) ~ 'CONCORDANT',
      .default = FLAG0
   ))

# overall % receiving, overall % recieving - discordant/concordant
sum(df$FLAG0 != 'No empiric therapy given') / nrow(df) * 100
t <- table(df$FLAG0[df$FLAG0 != 'No empiric therapy given'])
t / sum(t) * 100


df %>% 
   filter(FLAG0 != 'No empiric therapy given') %>% 
   mutate(NT = FLAG0 == 'NOT TESTED') %>% 
   summarise(n=n(), .by=c(BUG, NT)) %>% 
   tidyr::pivot_wider(names_from = NT, 
                      values_from = n) %>%
   rename(TR = `TRUE`, FA = `FALSE`) %>%
   mutate(total = TR + FA,
          pcnt = TR / total * 100) %>%
   select(-FA) %>%
   filter(total > 50L) %>%
   arrange(desc(pcnt))

empDF %>%
   filter(BUG == 'Escherichia coli', FLAG0 == 'NOT TESTED') %>%
   count(EMPIRIC0, sort=TRUE) %>%
   View()







par(cex.axis=0.9, cex.lab=0.9, cex.main=0.9)

#### Empiric discordance relative to recency of antibiotic prescriptions ####
empDF %>%
   mutate(prv_abx = !is.na(DAYS_SINCE_MOST_RECENT_ABX)) %>%
   summarise(sum(FLAG0 == 'DISCORDANT') / n(),
             .by = prv_abx)
t <- empDF %>%
   mutate(prv_abx = case_when(
      DAYS_SINCE_MOST_RECENT_ABX > 14L ~ '> 2w',
      DAYS_SINCE_MOST_RECENT_ABX > 7L & DAYS_SINCE_MOST_RECENT_ABX <= 14L ~ '1-2w',
      DAYS_SINCE_MOST_RECENT_ABX <= 7L & DAYS_SINCE_MOST_RECENT_ABX > 1L ~ '1w',
      DAYS_SINCE_MOST_RECENT_ABX == 1L ~ '1d',
      is.na(DAYS_SINCE_MOST_RECENT_ABX) ~ '> 1m'
   )) %>%
   summarise('discordant' = sum(FLAG0 == 'DISCORDANT') / n(),
             'concordant' = sum(FLAG0 == 'CONCORDANT') / n(),
             'no empiric abx' = sum(FLAG0 == 'No empiric therapy given') / n(),
             'not tested' = sum(FLAG0 == 'NOT TESTED') / n(),
             .by = prv_abx) %>%
   arrange(discordant)
n <- t$prv_abx
t <- as.matrix(t[-1])
rownames(t) <- n
t <- t(t)
b <- barplot(t, plot=FALSE)
y <- cumsum(c(0, t[,ncol(t)]))
y <- y[-1] - diff(y) / 2

par(mar=c(3.5,3,3,6), mgp=c(2, 0.5, 0), tck=-0.015)
barplot(t, xlab='Last antibiotic administration')
text(x=b[length(b)]+0.6, y=y, adj=0, labels=rownames(t), xpd=NA)






##################################
#### Day of first concordance ####
##################################
df <- empDF %>% select(FLAG0:FLAGT) %>% mutate(across(everything(), ~ ifelse(. == 'CONCORDANT', 1, 0)))
df <- apply(df, 1, function(x) which(x == 1)[1] - 1)
df[is.na(df)] <- 'never'
empDF$FIRST_CONC <- df
empDF <- empDF %>%
   mutate(FIRST_CONC = case_when(
      FIRST_CONC == '8' ~ as.character(DELAY),
      FIRST_CONC == '7' ~ as.character(DELAY - 1),
      .default = FIRST_CONC
   )) %>%
   relocate(FIRST_CONC, .before=FLAG0)

makeBarplot <- function(x, main='') {
   t <- table(x)
   t <- c(t[names(t) %in% as.character(0:7)], setNames(sum(t[!names(t) %in% c('never', as.character(0:7))]), '>7'), t['never'])
   if (!any(names(t) == '0')) t <- c(setNames(0, '0'), t)
   barplot(t, xlab='Days after AST order', main=main, space=c(rep(0.1, length(t)-1), 0.5), gap.axis=1e-11,
           col = ifelse(names(t)=='never', 'lightgray', 'darkgray'))
}
# plot overall
par(mfcol=c(1,2), mgp=c(1.75, 0.5, 0), mar=c(3,3.5,5,2))
makeBarplot(x = empDF$FIRST_CONC, main='Days until first concordant therapy')
makeBarplot(x = empDF$FIRST_CONC[empDF$FLAG0 == 'DISCORDANT'], main='Initially discordant:\nDays until first concordant therapy')

# bug-specific plots
makeBarplot <- function(bug, drug) {
   df <- empDF %>% filter(BUG == bug, DELAY <= 7L)
   t <- table(df$FIRST_CONC, df[[drug]])
   t <- t(apply(t, 2, function(x) x / sum(x) * 100))
   rownames(t)[rownames(t) == '0'] <- paste0(abbr[drug], '-S')
   rownames(t)[rownames(t) == '1'] <- paste0(abbr[drug], '-R')
   barplot(t, beside=TRUE, xlab='Days after AST order', legend=TRUE, ylab='% isolates')
   title(main='Days until first concordant therapy', line=1)
   title(main=bug, font.main=4, line=0)
}

par(mfrow=c(1,1), mgp=c(1.75, 0.5, 0), mar=c(5,5,5,5))
makeBarplot(bug='Enterococcus faecium', drug='VANCOMYCIN')
makeBarplot(bug='Staphylococcus aureus', drug='OXACILLIN')
makeBarplot('Klebsiella pneumoniae', drug='PIPERACILLIN/TAZOBACTAM')
makeBarplot('Klebsiella pneumoniae', drug='TRIMETHOPRIM/SULFAMETHOXAZOLE')
makeBarplot('Escherichia coli', drug='CIPROFLOXACIN')
makeBarplot('Escherichia coli', drug='TRIMETHOPRIM/SULFAMETHOXAZOLE')
makeBarplot('Enterococcus faecalis', drug='RIFAMPIN')
makeBarplot('Streptococcus pneumoniae', drug='ERYTHROMYCIN')
makeBarplot('Pseudomonas aeruginosa', drug='CIPROFLOXACIN')
makeBarplot('Serratia marcescens', drug='CEFTRIAXONE')
makeBarplot('Serratia marcescens', drug='PIPERACILLIN/TAZOBACTAM')
makeBarplot('Enterobacter cloacae', drug='PIPERACILLIN/TAZOBACTAM')




###########################################################
#### Empiric therapies / rates of discordance - BY BUG ####
###########################################################
makeFlagPlot <- function(e, main='', leg=FALSE, d) {
   pcnt_disc <- round(d['DISCORDANT'] / sum(d), 3) * 100
   n <- 8
   b <- barplot(rep(1,n), plot=F)
   h <- table(e$EMP0_ABBR, e$FLAG0)
   h <- t(head(h[order(rowSums(h), decreasing=TRUE), ], n))
   if (!'NOT TESTED' %in% rownames(h)) h <- rbind(h, 0); rownames(h)[nrow(h)] <- 'NOT TESTED'
   h <- h[c('DISCORDANT', 'CONCORDANT', 'NOT TESTED', 'No empiric therapy given'), ]
   colnames(h)[colnames(h) == ''] <- 'No abx'
   barplot(h, horiz=TRUE, names.arg=rep('', ncol(h)), legend=leg, xpd=NA, xaxt='n', font.main=4,
           col = gray.colors(n=4, start=0.2, end=0.92),
           main=paste0(main, '\n(n = ', prettyNum(nrow(e), big.mark=','), ' - ', pcnt_disc, '% discordant)'))
   axis(side=2, at=b, labels=colnames(h), las=1, tick=F)
   text(x = colSums(h) + max(h)*0.01, y = b, adj = 0, xpd=NA, labels = colSums(h))
}

PlotBug <- function(bug, drug) {
   bug_abbr <- gsub('^([A-Z])[a-z]+ ([a-z]+)$', '\\1_\\2', bug)
   bug_abbr_main <- gsub('_', '\\. ', bug_abbr)
   drug_abbr <- abbr[drug]
   cat(bug, '-', drug, '\n')
   
   e <- empDF %>% filter(BUG == bug) %>% mutate(!!drug := ifelse(is.na(get(drug)), -1, get(drug)))
   t <- e %>% filter(FLAG0 != 'No empiric therapy given') %>% select(FLAG0, !!drug) %>% table()
   
   layout(matrix(c(1,1,2,3), nrow=2, byrow=T))
   par(mar=c(0.5,7,3,4), mgp=c(1.5, 0.5, 0))
   makeFlagPlot(e=e, main=bug_abbr_main, leg=TRUE, d=rowSums(t))
   makeFlagPlot(e=e %>% filter(get(drug) == 0L), main=paste0(bug_abbr_main, ' ', drug_abbr, '-S'), d=t[,'0'])
   makeFlagPlot(e=e %>% filter(get(drug) == 1L), main=paste0(bug_abbr_main, ' ', drug_abbr, '-R'), d=t[,'1'])
}

PlotBug('Enterococcus faecium', 'VANCOMYCIN')
PlotBug('Staphylococcus aureus', 'OXACILLIN')
PlotBug('Klebsiella pneumoniae', 'PIPERACILLIN/TAZOBACTAM')
PlotBug('Klebsiella pneumoniae', 'TRIMETHOPRIM/SULFAMETHOXAZOLE')
PlotBug('Escherichia coli', 'CIPROFLOXACIN')
PlotBug('Escherichia coli', 'TRIMETHOPRIM/SULFAMETHOXAZOLE')
PlotBug('Enterococcus faecalis', 'RIFAMPIN')
PlotBug('Streptococcus pneumoniae', 'ERYTHROMYCIN')
PlotBug('Pseudomonas aeruginosa', 'CIPROFLOXACIN')
PlotBug('Serratia marcescens', 'CEFTRIAXONE')
PlotBug('Serratia marcescens', 'PIPERACILLIN/TAZOBACTAM')
PlotBug('Enterobacter cloacae', 'PIPERACILLIN/TAZOBACTAM')








#################################################
###### LEVEL OF RESISTANCE VS. DISCORDANCE ######
#################################################
getDF <- function(df, disc, prop=FALSE) {
   if (prop) {
      t <- apply(df %>% select(CEFEPIME:DELAFLOXACIN), 1, function(x) sum(x, na.rm=T) / sum(!is.na(x), na.rm=T))
      t <- round(t, 1)
   } else { 
      t <- apply(df %>% select(CEFEPIME:DELAFLOXACIN), 1, function(x) sum(x, na.rm=T))
   }
   disc <- disc == 'DISCORDANT'
   t <- table(t, disc)
   t <- t(t)
   t <- apply(t, 2, function(x) {
      p <- x['TRUE'] / sum(x)
      se <- 1.96 * sqrt((p * (1 - p)) / sum(x))
      names(p) <- NULL
      names(se) <- NULL
      return(c(est = p, se = se, n = sum(x)))
   })
   t <- data.frame(t(t))
   t <- t[t$n >= 10L, ]
   return(t)
}

toa <- getDF(empDFo, disc=empDF$FLAG0)
top <- getDF(empDFo, disc=empDF$FLAG0, prop=TRUE)
tia <- getDF(empDF, disc=empDF$FLAG0)
tip <- getDF(empDF, disc=empDF$FLAG0, prop=TRUE)
max_height <- max(c(toa$n, top$n, tia$n, tip$n))

makePlot <- function(t, xlab='', ylab=FALSE, prop=FALSE, max_height) {
   xvals <- as.numeric(rownames(t))
   plot(x = xvals,
        y = t$est,
        pch = 16, cex = 0.75,
        xlim = range(xvals) + ifelse(prop, 0.05, 0.5) * c(-1, 1), xaxs='i',
        ylim = c(0, 1), yaxt = 'n',
        ylab='', xlab='')
   title(xlab = paste0('Resistant phenotypes ', xlab), line=1.4)
   title(ylab = 'Proportion discordant', line=2)
   axis(side=2, at=seq(0,1,0.2), las=1)
   arrows(x0 = xvals, y0 = t$est - t$se, y1 = t$est + t$se,
          code=3, length=0.025, angle=90)
   
   par(new=TRUE)
   bar_col <- '#000000'
   bar_width <- ifelse(prop, 0.05, 0.5)
   bar_heights <- t$n / max_height
   rect(xleft = xvals - bar_width,
        xright = xvals + bar_width,
        ybottom = 0,
        ytop = bar_heights,
        border=NA,
        col = paste0(bar_col, '22'))
   sc_fac <- 10^(length(unlist(strsplit(as.character(max_height), '')))-1)
   s <- seq(0, floor(max_height/sc_fac)*sc_fac, sc_fac)
   axis(side=4, las=1, col=paste0(bar_col, '66'), col.axis=paste0(bar_col, '66'),
        at=seq(0, s[length(s)]/max_height, length.out=length(s)), 
        labels=s)
   mtext(side=4, line=2.25, text='Number of isolates', cex=par('cex.lab')-0.15, col=paste0(bar_col, '66'))
}

# overall plots
par(mfrow=c(1,1), mar=c(5,5.5,3,6), tck=-0.01, mgp=c(1.7, 0.3, 0), cex.lab=1)
makePlot(toa, 'measured (absolute number)', ylab=TRUE, max_height=max_height)
makePlot(top, 'measured (proportion - binned)', prop=TRUE, max_height=max_height)
makePlot(tia, 'imputed (absolute number)', max_height=max_height)
makePlot(tip, 'imputed (proportion - binned)', prop=TRUE, max_height=max_height)


# bug-specific plots
makeBugPlots <- function(bug) {
   toa <- getDF(empDFo[empDFo$BUG == bug, ], disc=empDF$FLAG0[empDF$BUG==bug])
   max_height <- max(toa$n)
   makePlot(toa, 'measured (absolute number)', ylab=TRUE, max_height=max_height)
   mtext(side=3, at=0.5, text=bug, outer=TRUE, line=-1, xpd=NA, font=2)
}

makeBugPlots('Staphylococcus aureus')
makeBugPlots('Enterococcus faecium')
makeBugPlots('Escherichia coli')
makeBugPlots('Proteus mirabilis')
makeBugPlots('Klebsiella pneumoniae')
```











